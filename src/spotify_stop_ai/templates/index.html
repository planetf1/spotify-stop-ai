{% extends "base.html" %}

{% block title %}Home - Spotify Stop AI{% endblock %}

{% block content %}
<div id="current-playback">
    {% if current_track %}
    <div class="current-playback">
        <h2>üéµ Now Playing</h2>
        <div class="track-info">
            <strong>{{ current_track.track_name }}</strong> by <strong>{{ current_track.artist_name }}</strong>
        </div>
        <div class="timestamp">Started: {{ current_track.timestamp }}</div>
        
        {% if current_artist_details %}
        <div class="card" style="margin-top: 1.5rem; padding: 1.5rem;">
            <h3 style="margin-top: 0;">Classification Results</h3>
            
            <!-- Overall Decision -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: rgba(29, 185, 84, 0.1); border-left: 4px solid 
                {% if current_artist_details.is_artificial == 1 %}#e22134{% elif current_artist_details.is_artificial == 0 %}#1db954{% else %}#b3b3b3{% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="font-size: 1.1rem;">Decision:</strong>
                        {% if current_artist_details.is_artificial == 1 %}
                        <span class="badge badge-ai" style="font-size: 1rem; margin-left: 0.5rem;">AI Generated</span>
                        {% elif current_artist_details.is_artificial == 0 %}
                        <span class="badge badge-human" style="font-size: 1rem; margin-left: 0.5rem;">Human Artist</span>
                        {% else %}
                        <span class="badge badge-unknown" style="font-size: 1rem; margin-left: 0.5rem;">Unknown</span>
                        {% endif %}
                        {% if current_artist_details.overridden %}
                        <span style="color: #1db954; font-size: 0.9rem; margin-left: 0.5rem;" title="Manual override applied">‚ö†Ô∏è Override</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>Confidence:</strong> 
                        <span style="font-size: 1.1rem;">{{ "%.0f"|format(current_artist_details.confidence * 100) }}%</span>
                    </div>
                </div>
                {% if current_artist_details.label %}
                <div style="margin-top: 0.5rem;">
                    <strong>Label:</strong> <span style="text-transform: capitalize;">{{ current_artist_details.label.replace('_', ' ') }}</span>
                </div>
                {% endif %}
                {% if current_artist_details.overridden and current_artist_details.override_reason %}
                <div style="margin-top: 0.5rem; color: #b3b3b3;">
                    <strong>Override Reason:</strong> {{ current_artist_details.override_reason }}
                </div>
                {% endif %}
            </div>
            
            <!-- Source Results -->
            {% if current_artist_details.sources %}
            <h4 style="margin-top: 1.5rem; margin-bottom: 1rem;">Source Results:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                {% for source in current_artist_details.sources %}
                <div style="padding: 1rem; border: 2px solid 
                    {% if source.is_artificial == 1 %}#e22134{% elif source.is_artificial == 0 %}#1db954{% else %}#b3b3b3{% endif %}; 
                    border-radius: 8px; background-color: rgba(
                    {% if source.is_artificial == 1 %}226, 33, 52{% elif source.is_artificial == 0 %}29, 185, 84{% else %}179, 179, 179{% endif %}, 0.05);">
                    <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.9rem; color: #b3b3b3;">
                        {{ source.source_name }}
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        {% if source.is_artificial == 1 %}
                        <span class="badge badge-ai">AI</span>
                        {% elif source.is_artificial == 0 %}
                        <span class="badge badge-human">Human</span>
                        {% else %}
                        <span class="badge badge-unknown">Unknown</span>
                        {% endif %}
                        <span style="margin-left: 0.5rem;">{{ "%.0f"|format(source.confidence * 100) }}%</span>
                    </div>
                    {% if source.label %}
                    <div style="font-size: 0.85rem; color: #b3b3b3;">
                        Label: <span style="text-transform: capitalize;">{{ source.label.replace('_', ' ') }}</span>
                    </div>
                    {% endif %}
                    {% if source.tags %}
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #b3b3b3;">
                        Tags: {{ source.tags[:3]|join(', ') }}{% if source.tags|length > 3 %}...{% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- LLM Fallback Analysis -->
            {% if current_artist_details.llm_output %}
            <div style="margin-top: 1.5rem; padding: 1rem; border: 2px solid #ffa500; border-radius: 8px; background-color: rgba(255, 165, 0, 0.05);">
                <h4 style="margin-top: 0; color: #ffa500;">ü§ñ LLM Analysis</h4>
                <div style="margin-bottom: 0.5rem;">
                    <strong>Model:</strong> {{ current_artist_details.llm_output.model }}
                </div>
                {% if current_artist_details.llm_output.output %}
                <div style="margin-bottom: 0.5rem;">
                    <strong>Result:</strong>
                    {% if current_artist_details.llm_output.output.is_artificial == True %}
                    <span class="badge badge-ai">AI</span>
                    {% elif current_artist_details.llm_output.output.is_artificial == False %}
                    <span class="badge badge-human">Human</span>
                    {% else %}
                    <span class="badge badge-unknown">Unknown</span>
                    {% endif %}
                    <span style="margin-left: 0.5rem;">{{ "%.0f"|format(current_artist_details.llm_output.output.confidence * 100) }}%</span>
                </div>
                {% if current_artist_details.llm_output.output.reason %}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: rgba(0, 0, 0, 0.2); border-radius: 4px; font-size: 0.9rem;">
                    {{ current_artist_details.llm_output.output.reason }}
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% endif %}
            
            <div style="margin-top: 1.5rem;">
                <a href="/artist/{{ current_track.artist_id }}" class="btn">Full Details & History</a>
            </div>
        </div>
        {% elif current_track.artist_id %}
        <div style="margin-top: 1rem;">
            <a href="/artist/{{ current_track.artist_id }}" class="btn">View Artist Details</a>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="card">
        <h2>üéµ Now Playing</h2>
        <p style="color: #b3b3b3;">No track currently playing</p>
    </div>
    {% endif %}
</div>

<div class="grid">
    <div class="card">
        <h2>üìä Recent Plays</h2>
        {% if plays %}
        <table>
            <thead>
                <tr>
                    <th>Artist</th>
                    <th>Track</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                {% for play in plays[:5] %}
                <tr>
                    <td>
                        <a href="/artist/{{ play.artist_id }}">{{ play.artist_name or 'Unknown' }}</a>
                    </td>
                    <td>{{ play.track_name or 'Unknown' }}</td>
                    <td class="timestamp">{{ play.timestamp }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top: 1rem;">
            <a href="/plays" class="btn btn-secondary">View All Plays</a>
        </div>
        {% else %}
        <p style="color: #b3b3b3;">No plays recorded yet</p>
        {% endif %}
    </div>
    
    <div class="card">
        <h2>ü§ñ Recent Decisions</h2>
        {% if decisions %}
        <table>
            <thead>
                <tr>
                    <th>Artist</th>
                    <th>Result</th>
                    <th>Confidence</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for decision in decisions[:5] %}
                <tr>
                    <td>
                        <a href="/artist/{{ decision.artist_id }}">{{ decision.artist_name or 'Unknown' }}</a>
                    </td>
                    <td>
                        {% if decision.is_artificial == 1 %}
                        <span class="badge badge-ai">AI Generated</span>
                        {% elif decision.is_artificial == 0 %}
                        <span class="badge badge-human">Human</span>
                        {% else %}
                        <span class="badge badge-unknown">Unknown</span>
                        {% endif %}
                        {% if decision.overridden %}
                        <span style="color: #1db954; font-size: 0.75rem; margin-left: 0.5rem;" title="Manual override applied">‚ö†Ô∏è</span>
                        {% endif %}
                        {% if decision.context_count %}
                        <span style="color: #b3b3b3; font-size: 0.8rem; margin-left: 0.5rem;" title="Checked {{ decision.context_count }} sources">
                            ({{ decision.context_count }} sources)
                        </span>
                        {% endif %}
                    </td>
                    <td class="confidence">{{ "%.0f"|format(decision.confidence * 100) }}%</td>
                    <td>
                        <a href="/artist/{{ decision.artist_id }}" class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.85rem;">Details</a>
                        {% if decision.is_artificial != 1 %}
                        <form method="post" action="/override/{{ decision.artist_id }}" style="display: inline;">
                            <input type="hidden" name="is_artificial" value="true">
                            <input type="hidden" name="reason" value="Manual override from dashboard">
                            <button type="submit" class="btn btn-danger" style="padding: 0.3rem 0.8rem; font-size: 0.85rem;">Mark AI</button>
                        </form>
                        {% endif %}
                        {% if decision.is_artificial != 0 %}
                        <form method="post" action="/override/{{ decision.artist_id }}" style="display: inline;">
                            <input type="hidden" name="is_artificial" value="false">
                            <input type="hidden" name="reason" value="Manual override from dashboard">
                            <button type="submit" class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.85rem;">Mark Human</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top: 1rem;">
            <a href="/decisions" class="btn btn-secondary">View All Decisions</a>
        </div>
        {% else %}
        <p style="color: #b3b3b3;">No decisions recorded yet</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    // Auto-refresh current playback every 5 seconds
    setInterval(async () => {
        try {
            const response = await fetch('/api/current');
            const data = await response.json();
            
            if (data.current_track) {
                const currentDiv = document.getElementById('current-playback');
                const currentTrack = data.current_track;
                
                currentDiv.innerHTML = `
                    <div class="current-playback">
                        <h2>üéµ Now Playing</h2>
                        <div class="track-info">
                            <strong>${currentTrack.track_name}</strong> by <strong>${currentTrack.artist_name}</strong>
                        </div>
                        <div class="timestamp">Started: ${currentTrack.timestamp}</div>
                        ${currentTrack.artist_id ? `
                        <div style="margin-top: 1rem;">
                            <a href="/artist/${currentTrack.artist_id}" class="btn">View Artist Details</a>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Failed to refresh playback:', error);
        }
    }, 5000);
</script>
{% endblock %}
