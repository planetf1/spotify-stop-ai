{% extends "base.html" %}

{% block title %}Artist Details - Spotify Stop AI{% endblock %}

{% block content %}
<div class="card">
    <h2>üé§ {{ artist.name }}</h2>
    <p class="timestamp">Spotify ID: {{ artist.id }}</p>
    
    {% if override %}
    <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Override Active:</strong> This artist is manually classified as 
        {% if override.is_artificial %}AI Generated{% else %}Human{% endif %}
        {% if override.reason %}<br>Reason: {{ override.reason }}{% endif %}
        
        <form method="post" action="/override/{{ artist.id }}/delete" style="display: inline; margin-left: 1rem;">
            <button type="submit" class="btn btn-danger">Remove Override</button>
        </form>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3>üîÑ Reclassify Artist</h3>
    <form method="post" action="/reclassify/{{ artist.id }}">
        <input type="hidden" name="artist_name" value="{{ artist.name }}">
        <button type="submit" class="btn">Run Classification Now</button>
    </form>
</div>

<div class="card">
    <h3>‚öôÔ∏è Set Manual Override</h3>
    <form method="post" action="/override/{{ artist.id }}">
        <div class="form-group">
            <label for="is_artificial">Classification:</label>
            <select name="is_artificial" id="is_artificial" required>
                <option value="true">AI Generated</option>
                <option value="false">Human Artist</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="reason">Reason (optional):</label>
            <textarea name="reason" id="reason" rows="3" placeholder="Why are you setting this override?"></textarea>
        </div>
        
        <button type="submit" class="btn">Set Override</button>
    </form>
</div>

<div class="card">
    <h3>ü§ñ Classification History ({{ decisions|length }})</h3>
    {% if decisions %}
    {% for decision in decisions %}
    <div class="source-result" style="margin-bottom: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
                <div class="source-name" style="font-size: 1.1rem;">
                    Decision: {{ decision.label }}
                    {% if decision.is_artificial == 1 %}
                    <span class="badge badge-ai">AI Generated</span>
                    {% elif decision.is_artificial == 0 %}
                    <span class="badge badge-human">Human</span>
                    {% else %}
                    <span class="badge badge-unknown">Unknown</span>
                    {% endif %}
                </div>
                <div class="timestamp">{{ decision.timestamp }}</div>
            </div>
            <div class="confidence" style="font-size: 1.1rem;">
                Confidence: {{ "%.0f"|format(decision.confidence * 100) }}%
            </div>
        </div>
        
        {% if decision.decision_reason %}
        <div style="margin-bottom: 0.5rem;">
            <strong>Reason:</strong> {{ decision.decision_reason }}
        </div>
        {% endif %}
        
        <div style="margin-bottom: 0.5rem;">
            <strong>Sources:</strong> {{ decision.sources_agreeing }} of {{ decision.min_required }} required sources agreed
            {% if decision.band_policy_applied %}
            <span style="color: #1db954;"> (Band policy applied)</span>
            {% endif %}
            {% if decision.llm_used %}
            <span style="color: #ffeb3b;"> (LLM used)</span>
            {% endif %}
        </div>
        
        {% if decision.sources %}
        <details open style="margin-top: 1rem; background: #181818; padding: 1rem; border-radius: 8px;">
            <summary style="cursor: pointer; color: #1db954; font-weight: 600; font-size: 1.05rem; margin-bottom: 1rem;">
                üìä Individual Source Results ({{ decision.sources|length }} sources checked)
            </summary>
            <div style="margin-top: 1rem;">
                {% for source in decision.sources %}
                <div style="background: #282828; padding: 1rem; margin: 0.75rem 0; border-radius: 6px; border-left: 3px solid {% if source.result == 'artificial' or source.result == 'ai' %}#ff4444{% elif source.result == 'human' %}#1db954{% else %}#b3b3b3{% endif %};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div class="source-name" style="font-size: 1rem; font-weight: 600;">
                            {{ source.source_name }}
                        </div>
                        <div>
                            {% if source.result == 'artificial' or source.result == 'ai' %}
                            <span class="badge badge-ai">AI</span>
                            {% elif source.result == 'human' %}
                            <span class="badge badge-human">Human</span>
                            {% elif source.result == 'unknown' %}
                            <span class="badge badge-unknown">Unknown</span>
                            {% elif source.result == 'error' %}
                            <span class="badge" style="background: #ff9800;">Error</span>
                            {% else %}
                            <span class="badge">{{ source.result }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if source.signals %}
                    <div style="margin-top: 0.5rem; color: #b3b3b3;">
                        <strong style="color: #fff;">Signals:</strong> {{ source.signals }}
                    </div>
                    {% endif %}
                    
                    {% if source.url %}
                    <div style="margin-top: 0.5rem;">
                        <a href="{{ source.url }}" target="_blank" style="color: #1db954; text-decoration: none;">üîó View Source Data</a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </details>
        {% else %}
        <div style="margin-top: 1rem; color: #b3b3b3;">
            <em>No individual source details available for this decision.</em>
        </div>
        {% endif %}
        
        {% if decision.llm_used and decision.llm_output %}
        <details open style="margin-top: 1rem; background: #181818; padding: 1rem; border-radius: 8px; border: 2px solid #ffeb3b;">
            <summary style="cursor: pointer; color: #ffeb3b; font-weight: 600; font-size: 1.05rem; margin-bottom: 1rem;">
                ü§ñ LLM Fallback Analysis ({{ decision.llm_output.model }})
            </summary>
            <div style="margin-top: 1rem;">
                <div style="background: #282828; padding: 1rem; border-radius: 6px;">
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #ffeb3b;">Model:</strong> {{ decision.llm_output.model }}
                    </div>
                    
                    {% if decision.llm_output.output %}
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #ffeb3b;">LLM Response:</strong>
                        <pre style="background: #1a1a1a; padding: 1rem; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem; color: #e0e0e0;">{{ decision.llm_output.output }}</pre>
                    </div>
                    {% endif %}
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 1rem; color: #b3b3b3; font-size: 0.9rem;">
                        {% if decision.llm_output.prompt_eval_count %}
                        <div>
                            <strong>Prompt tokens:</strong> {{ decision.llm_output.prompt_eval_count }}
                        </div>
                        {% endif %}
                        {% if decision.llm_output.eval_count %}
                        <div>
                            <strong>Response tokens:</strong> {{ decision.llm_output.eval_count }}
                        </div>
                        {% endif %}
                        {% if decision.llm_output.total_duration_ms %}
                        <div>
                            <strong>Total time:</strong> {{ "%.0f"|format(decision.llm_output.total_duration_ms) }}ms
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if decision.llm_output.prompt %}
                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: #1db954; font-size: 0.9rem;">
                            View Full Prompt
                        </summary>
                        <pre style="background: #1a1a1a; padding: 1rem; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem; color: #b3b3b3; font-size: 0.85rem;">{{ decision.llm_output.prompt }}</pre>
                    </details>
                    {% endif %}
                </div>
            </div>
        </details>
        {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <p style="color: #b3b3b3;">No classification decisions recorded for this artist yet.</p>
    {% endif %}
</div>

<div class="card">
    <h3>üìä Recent Plays ({{ plays|length }})</h3>
    {% if plays %}
    <table>
        <thead>
            <tr>
                <th>Track</th>
                <th>Time</th>
                <th>Skipped</th>
            </tr>
        </thead>
        <tbody>
            {% for play in plays %}
            <tr>
                <td>{{ play.track_name }}</td>
                <td class="timestamp">{{ play.timestamp }}</td>
                <td>{% if play.skipped %}‚úÖ Yes{% else %}‚ùå No{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #b3b3b3;">No plays recorded for this artist yet.</p>
    {% endif %}
</div>

<div style="margin-top: 2rem;">
    <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
</div>
{% endblock %}
